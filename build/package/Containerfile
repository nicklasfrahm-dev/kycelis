# Build the application.
FROM golang AS build

WORKDIR /app
COPY go.* /app/
RUN go mod download

COPY . /app/
ARG VERSION
RUN VERSION=$VERSION make build

CMD [ "/app/bin/kycelisd" ]

# Build the final image.
FROM gcr.io/distroless/static-debian12:nonroot AS run

LABEL org.opencontainers.image.documentation="/app/README.md"
LABEL org.opencontainers.image.authors="Nicklas Frahm <nicklas.frahm@gmail.com>"
LABEL org.opencontainers.image.source="https://github.com/nicklasfrahm-dev/kycelis"

ARG VERSION
LABEL org.opencontainers.image.version="$VERSION"

COPY --from=build /app/README.md /app/README.md
COPY --from=build /app/bin/kycelisd /app/kyselisd

USER nonroot:nonroot
WORKDIR /app

CMD ["/app/kyselisd"]
